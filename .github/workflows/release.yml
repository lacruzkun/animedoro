name: Release


on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          pkg-config \
          libgtk-4-dev \
          libglib2.0-dev \
          libpango1.0-dev \
          libcairo2-dev \
          libgdk-pixbuf-2.0-dev \
          libfuse2 \
          patchelf \
          wget

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binary
      run: cargo build --release

    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications

        cp target/release/animedoro AppDir/usr/bin/
        mv AppDir/usr/bin/animedoro AppDir/usr/bin/Animedoro
        cp -r resources AppDir/usr/bin/

        cp Animedoro.desktop AppDir/usr/share/applications/

    - name: Create AppRun
      run: |
        cat << 'EOF' > AppDir/AppRun
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "$0")")"
        export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"
        exec "$HERE/usr/bin/Animedoro"
        EOF
        chmod +x AppDir/AppRun

    - name: Generate placeholder icon
      run: |
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        printf '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x01\x00\x00\x00\x01\x00\x08\x02\x00\x00\x00\x90wS\xde\x00\x00\x00\nIDATx\x9cc`\x00\x00\x00\x02\x00\x01\xe2!\xbc3\x00\x00\x00\x00IEND\xaeB`\x82' \
        > AppDir/usr/share/icons/hicolor/256x256/apps/Animedoro.png

    - name: Download appimagetool
      run: |
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool

    - name: Build AppImage
      run: |
        ARCH=x86_64 ./appimagetool AppDir Animedoro-x86_64.AppImage

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: Animedoro-AppImage
        path: Animedoro-x86_64.AppImage

  macos:
    name: macOS (universal)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew update
          brew install gtk4 pkg-config

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-bundle
        run: cargo install cargo-bundle

      - name: Build and bundle
        run: cargo bundle --release

      - name: Zip app bundle
        run: |
          cd target/release/bundle/osx
          zip -r Animedoro-macos.zip Animedoro.app

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: target/release/bundle/osx/Animedoro-macos.zip

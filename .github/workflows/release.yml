name: Release


on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            libgtk-4-dev \
            libglib2.0-dev \
            libpango1.0-dev \
            libcairo2-dev \
            libxkbcommon-dev \
            patchelf

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build
        run: cargo build --release

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share
          cp target/release/animedoro AppDir/usr/bin/
          cp -r resources AppDir/usr/share/

      - name: Download linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Download GTK plugin
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-gtk/releases/download/continuous/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-plugin-gtk.sh

      - name: Build AppImage
        run: |
          export LINUXDEPLOY_PLUGINS=gtk
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/animedoro \
            --desktop-file your.desktop \
            --output appimage

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Animedoro-x86_64.AppImage

  macos:
    name: macOS (universal)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew update
          brew install gtk4 pkg-config

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-bundle
        run: cargo install cargo-bundle

      - name: Build and bundle
        run: cargo bundle --release

      - name: Zip app bundle
        run: |
          cd target/release/bundle/osx
          zip -r Animedoro-macos.zip Animedoro.app

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: target/release/bundle/osx/Animedoro-macos.zip
